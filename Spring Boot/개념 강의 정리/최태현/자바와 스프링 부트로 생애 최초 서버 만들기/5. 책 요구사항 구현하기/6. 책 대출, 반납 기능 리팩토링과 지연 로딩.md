# 책 대출, 반납 기능 리팩토링과 지연 로딩
## 1) 대출 기능 리팩토링
- UserLoanHistory를 User안에서 처리하도록 리팩토링
	- cascade 옵션 사용

### (1) User 객체
- User 객체에 UserLoanHistory를 연결시켜준다.
```java
// User
...

@OneToMany(mappedBy = "user", cascade = CascadeType.ALL, orphanRemoval = true)  
private List<UserLoanHistory> userLoanHistories = new ArrayList<>();

...

public void loanBook(String bookName) {
	// this = user
	this.userLoanHistories.add(new UserLoanHistory(this, bookName));  
}
```

### (2) BookService
- `loanBook()` 에서 UserLoanHistory를 직접 서비스가 만들어서 UserLoanHistoryRepository를 통해 save도 직접 해줬었다.
```java
	...
	user.loanBook(book.getName());
  
    // 이제 필요 없다.
    // userLoanHistoryRepository.save(new UserLoanHistory(user, book.getName()));
	...
```
- cascade 옵션에 의해서 User와 User가 가지고 있는 리스트 안에 새로운 UserLoanHistory가 들어가게 된다.
- 그러면 트랜잭션이 끝날 때 User안에 새로운 연결관계가 자동으로 체크되서 UserLoanHistory가 자동으로 저장된다.
- 이렇게 User와 UserLoanHistory가 직접 협력하게 되었다.
	- 이런식으로 domain 계층에 있는 User와 UserLoanHistory가 직접적으로 협력하게 바뀐것을, 도메인 계층에 비즈니스 로직이 들어갔다고 부르기도 한다.

## 2) 반납 기능 리팩토링
- BookService에서 User만 가져와서 User에 연결된 UserLoanHistory가 알아서 처리되게 해준다.

