# 상품 레포지토리와 엔티티 CRUD 구현하기
## 1) 상품 레포지토리 구현하기
```java
package org.mall.shoppingmallapi.repository;

import org.springframework.data.jpa.repository.JpaRepository;

public interface ProductRepository extends JpaRepository<Product, Long> {   
}
```

## 2) 엔티티 CRUD 구현하기
### (1) 조회 (Read)
- 연관관계에서 `ToString`을 조심해야한다.
	- `@ToString(exclude = "imageList")`
		- 조회 시 `imageList`를 갖고 오지 않는다.
		- 이럴때는 트랜잭션이 필요하지 않다.
		- `exclude`를 하지 않으면 `Product`에서 한 번, `ProductImage`에서 한 번, 총 두 번 갖고오게 된다.
- 그래서 `@EntityGraph`나 `Join`해서 만들어서 써야한다.
```java
public interface ProductRepositoryTwo extends JpaRepository<Product, Long> {
    @EntityGraph(attributePaths = "imageList")
    @Query("select p from Product p where p.pno = :pno")
    Optional<Product> selectOne(@Param("pno") Long pno);
    ...
```

#### 테스트 코드
```java
@Test  
public void testRead() {
    Long pno = 1L;

    Optional<Product> result = productRepositoryTwo.selectOne(pno);
  
    Product product = result.orElseThrow();
  
    log.info(product);
    log.info(product.getImageList());
}
```

### (2) 삭제 (Delete)
- 실제 DB의 데이터를 지우는 게 아니라 컬럼값을 수정하는 것이다.
```java
@Modifying
@Query("update Product p set p.delFlag = :flag where p.pno = :pno")
void updateToDelete(@Param("pno") Long pno, @Param("flag") boolean flag);
```

#### 테스트 코드
```java
@Commit
@Transactional
@Test
public void testDelete() {
    Long pno = 2L;

    productRepositoryTwo.updateToDelete(pno, true);
}
```

### (3) 수정 (Update)
- 상품 수정에서 이미지를 변경하는 경우도 많을 것이다.
- 해당 부분은 테스트 코드만 확인해보자.
```java
@Test
public void testUpdate() {
    Product product = productRepositoryTwo.selectOne(1L).get();

    product.changePrice(3000);

    // 만약 다른 arrayList를 쓰면 안된다.
    //JPA가 해당 arrayList를 사용하고 있으므로 쓰고 있던 것을 계속 써야한다.
    product.clearList();

    product.addImageString(UUID.randomUUID()+"_"+"UPIMAGE3.jpg");
    product.addImageString(UUID.randomUUID()+"_"+"UPIMAGE4.jpg");
    product.addImageString(UUID.randomUUID()+"_"+"UPIMAGE5.jpg");
    productRepositoryTwo.save(product);
}
```
