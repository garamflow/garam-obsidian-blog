# 멤버 엔티티, 레포지토리 구현
## 1) 멤버 권한 enum 만들기
- 멤버의 권한에 대한 enum을 만들어준다.
```java
package org.mall.shoppingmallapi.domain;

public enum MemberRole {
    USER, MANAGER, ADMIN
}
```

## 2) 멤버 엔티티 생성
```java
package org.mall.shoppingmallapi.domain;

import jakarta.persistence.ElementCollection;
import jakarta.persistence.Entity;
import jakarta.persistence.FetchType;
import jakarta.persistence.Id;
import lombok.*;

import java.util.ArrayList;
import java.util.List;

@Entity
@Builder
@AllArgsConstructor
@NoArgsConstructor
@Getter
@ToString(exclude = "memberRoleList")
public class Member {
    @Id
    private String email;
    private String password;
    private String nickName;
    private boolean social;

    @ElementCollection(fetch = FetchType.LAZY)
    @Builder.Default
    private List<MemberRole> memberRoleList = new ArrayList<>();

    public void addRole(MemberRole memberRole) {
        memberRoleList.add(memberRole);
    }

    public void clearRole() {
        memberRoleList.clear();
    }

    public void changeNickname(String nickName) {
        this.nickName = nickName;
    }

    public void changePassword(String password) {
        this.password = password;
    }

    public void changeSocial(boolean social) {
        this.social = social;
    }
}
```

## 3) 멤버 레포지토리 구현
```java
package org.mall.shoppingmallapi.repository;

import org.mall.shoppingmallapi.domain.Member;
import org.springframework.data.jpa.repository.EntityGraph;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;

public interface MemberRepository extends JpaRepository<Member, String> {
    @EntityGraph(attributePaths = {"memberRoleList"})
    @Query("select m from Member m where m.email = :email")
    Member getWithRoles(@Param("email") String email);
}
```

## 4) 레포지토리 테스트 구현
- 회원 가입시 패스워드는 반드시 인코딩해줘야한다.

```java
package org.mall.shoppingmallapi.repository;

import lombok.extern.log4j.Log4j2;
import org.junit.jupiter.api.Test;
import org.mall.shoppingmallapi.domain.Member;
import org.mall.shoppingmallapi.domain.MemberRole;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.security.crypto.password.PasswordEncoder;

@SpringBootTest
@Log4j2
public class MemberRepositoryTests {
    @Autowired
    private MemberRepository memberRepository;
    @Autowired
    private PasswordEncoder passwordEncoder;

    @Test
    public void testInsertMember() {
        for(int i = 0; i < 10; i++) {
            Member member = Member.builder()
                    .email("user"+i+"@aaa.com")
                    .password(passwordEncoder.encode("1111"))
                    .nickName("USER" + i)
                    .build();
            member.addRole(MemberRole.USER);
            if(i >= 5) member.addRole(MemberRole.MANAGER);
            if(i >= 8) member.addRole(MemberRole.ADMIN);
            memberRepository.save(member);
        }
    }

    @Test
    public void testRead() {
        String email = "user9@aaa.com";

        Member member = memberRepository.getWithRoles(email);
        log.info("------------");
        log.info(member);
    }
}
```