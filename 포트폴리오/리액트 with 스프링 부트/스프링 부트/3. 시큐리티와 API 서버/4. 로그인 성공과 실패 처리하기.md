# 로그인 성공과 실패 처리하기
## 1) Gson 설치하기
- 로그인 성공 후 `AuthenticationSuccessHandler`라는 것을 통해 후처리 작업이 가능하다.
- API 서버의 경우 로그인 후 JSON 문자열을 생성해서 전달하도록 구현해줘야 한다.
- JSON 문자열 생성은 Gson 라이브러리를 활용해서 객체를 JSON 문자열로 처리한다.
```xml
dependencies {
	implementation 'com.google.code.gson:gson:2.10.1'
}
```

## 2) 로그인 성공 후 처리 클래스 구현
- `AuthenticationSuccessHandler`를 구현하는 클래스를 만들어준다.
- 그리고 로그인 후 처리를 `CustomSecurityConfig` 에도 등록해줘야한다.
```java
package org.mall.shoppingmallapi.security.handler;

import com.google.gson.Gson;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.extern.log4j.Log4j2;
import org.mall.shoppingmallapi.dto.MemberDTO;
import org.springframework.security.core.Authentication;
import org.springframework.security.web.authentication.AuthenticationSuccessHandler;

import java.io.IOException;
import java.io.PrintWriter;
import java.util.Map;

@Log4j2
public class APILoginSuccessHandler implements AuthenticationSuccessHandler {
    @Override
    public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException, ServletException {
        log.info("-----------");
        log.info(authentication);
        log.info("-----------");
    }
}
```

```java
public class CustomSecurityConfig {
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        ...
        http.formLogin(httpSecurityFormLoginConfigurer -> {
            httpSecurityFormLoginConfigurer.loginPage("/api/member/login");
            httpSecurityFormLoginConfigurer.successHandler(new APILoginSuccessHandler());
        });
        ...
```
## 3) JSON 결과 전송하기
- 성공하면 `APILoginSuccessHandler`를 활용해서 응답 메시지를 생성시켜야 한다.
- 응답 메시지는 `MemberDTO` 안에 있는 `getClaims()`를 통해서 JSON 데이터를 구성하면 된다.
- Postman으로 확인하면 정상적으로 JSON이 현출된다.
```java
public class APILoginSuccessHandler implements AuthenticationSuccessHandler {
    @Override
    public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException, ServletException {
        log.info("-----------");
        log.info(authentication);
        log.info("-----------");

        MemberDTO memberDTO = (MemberDTO) authentication.getPrincipal();

        Map<String, Object> claims = memberDTO.getClaims();
        claims.put("accessToken", "");
        claims.put("refreshToken", "");

        Gson gson = new Gson();
        String jsonStr = gson.toJson(claims);

        response.setContentType("application/json; charset=UTF-8");
        PrintWriter printWriter = response.getWriter();
        printWriter.println(jsonStr);
        printWriter.close();
    }
}
```

## 4) 로그인 실패 처리하기
- API 서버는 실패했을 시 어떻게든 메시지를 보여줘야한다.
	- 큰 업체들은 200을 보내면서 로그인을 못한다고 보여준다.
- API 서버 호출 결과 로그인을 할 수 없다면 예외를 발생시켜야한다.
- `org.springframework.security.web.authentication.AuthenticationFailureHandler`
- `CustomSecurityConfig`에도 등록해줘야 한다.
```java
package org.mall.shoppingmallapi.security.handler;

import com.google.gson.Gson;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.extern.log4j.Log4j2;
import org.springframework.security.core.AuthenticationException;
import org.springframework.security.web.authentication.AuthenticationFailureHandler;

import java.io.IOException;
import java.io.PrintWriter;
import java.util.Map;

@Log4j2
public class APILoginFailHandler implements AuthenticationFailureHandler {
    @Override
    public void onAuthenticationFailure(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception) throws IOException, ServletException {
        log.info("Login fail....." + exception);

        Gson gson = new Gson();
        String jsonStr = gson.toJson(Map.of("error", "ERROR_LOGIN"));
        response.setContentType("application/json");
        PrintWriter printWriter = response.getWriter();
        printWriter.println(jsonStr);
        printWriter.close();
    }
}
```

```java
public class CustomSecurityConfig {
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        ...
        http.formLogin(httpSecurityFormLoginConfigurer -> {
            httpSecurityFormLoginConfigurer.loginPage("/api/member/login");
            httpSecurityFormLoginConfigurer.successHandler(new APILoginSuccessHandler());
            httpSecurityFormLoginConfigurer.failureHandler(new APILoginFailHandler());
        });
        ...
```