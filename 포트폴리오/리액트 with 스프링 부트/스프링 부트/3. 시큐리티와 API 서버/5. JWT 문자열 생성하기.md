# JWT 문자열 생성하기
## 1) JJWT 설치하기
- JAVA에서 JWT를 구성할 때 자주 쓰이는 라이브러리이다.
- 버전별로 사용법이 다른점이 있으므로 주의해야한다.
```xml
dependencies{
	implementation 'io.jsonwebtoken:jjwt-api:0.11.5'  
	runtimeOnly 'io.jsonwebtoken:jjwt-impl:0.11.5'  
	runtimeOnly 'io.jsonwebtoken:jjwt-jackson:0.11.5'
}
```

## 2) JWT 문자열 생성과 검증
- 먼저 `util` 패키지 내부에 `JWTUtil`과 `CustomJWTException` 클래스를 생성해주자.
	- `CustomJWTException` : 사용자 정의 예외
	- `JWTUtil` : 문자열 생성과 검증
### (1) CustomJWTException
```java
package org.mall.shoppingmallapi.util;

public class CustomJWTException extends RuntimeException {
    public CustomJWTException(String msg) {
        super(msg);
    }
}
```

### (2) JWTUtil
```java
package org.mall.shoppingmallapi.util;

import io.jsonwebtoken.*;
import io.jsonwebtoken.security.Keys;
import lombok.extern.log4j.Log4j2;

import javax.crypto.SecretKey;
import java.time.ZonedDateTime;
import java.util.Date;
import java.util.Map;

@Log4j2
public class JWTUtil {
    private static String key = "1234567890123456789012345678901234567890";

    public static String generateToken(Map<String, Object> valueMap, int min) {
        SecretKey key = null;
        try{
            key = Keys.hmacShaKeyFor(JWTUtil.key.getBytes("UTF-8"));
        }catch(Exception e){
            throw new RuntimeException(e.getMessage());
        }
        String jwtStr = Jwts.builder()
                .setHeader(Map.of("typ","JWT"))
                .setClaims(valueMap)
                .setIssuedAt(Date.from(ZonedDateTime.now().toInstant()))
                .setExpiration(Date.from(ZonedDateTime.now().plusMinutes(min).toInstant()))
                .signWith(key)
                .compact();
        return jwtStr;
    }

    public static Map<String, Object> validateToken(String token) {
        Map<String, Object> claim = null;
        try{
            SecretKey key = Keys.hmacShaKeyFor(JWTUtil.key.getBytes("UTF-8"));
            claim = Jwts.parserBuilder()
                    .setSigningKey(key)
                    .build()
                    .parseClaimsJws(token) // 파싱 및 검증, 실패 시 에러
                    .getBody();
        }catch(MalformedJwtException malformedJwtException){
            throw new CustomJWTException("MalFormed");
        }catch(ExpiredJwtException expiredJwtException){
            throw new CustomJWTException("Expired");
        }catch(InvalidClaimException invalidClaimException){
            throw new CustomJWTException("Invalid");
        }catch(JwtException jwtException){
            throw new CustomJWTException("JWTError");
        }catch(Exception e){
            throw new CustomJWTException("Error");
        }
        return claim;
    }
}
```

## 3) 검증 시 JWT 토큰 삽입 시키기
```java
public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException, ServletException {
        log.info("-----------");
        log.info(authentication);
        log.info("-----------");

        MemberDTO memberDTO = (MemberDTO) authentication.getPrincipal();

        Map<String, Object> claims = memberDTO.getClaims();

        String accessToken = JWTUtil.generateToken(claims, 10);
        String refreshToken = JWTUtil.generateToken(claims, 60*24);

        claims.put("accessToken", accessToken);
        claims.put("refreshToken", refreshToken);
        ...
```

## 4) 토큰 검증하기
- Postman으로 로그인 시, accessToken과 refreshToken이 생성된 것을 확인할 수 있다.
- 생성된 토큰의 검증은 jwt.io 사이트에서 확인 가능하다.