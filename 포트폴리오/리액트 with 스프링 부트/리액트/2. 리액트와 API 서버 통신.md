# 리액트와 API 서버 통신
- 개발 순서는
	1. API 서버와 호출 부분
	2. 컴포넌트 만들기
	3. 페이지에 붙이기
	4. 화면 처리하기
	5. 이후 모달 처리하기


## 1) Ajax를 위한 Axios 설정
- `npm install axios`
	- 기본적으로 json을 사용하는데, axios는 json 데이터를 다룰 때 편하다.
- async 함수의 모든 리턴은 promise이다.
	- 비동기여서
- `useEffect`
	- 비동기 통신으로 인해 상태 변화가 생기고 컴포넌트가 다시 리렌더링되는게 반복될 수 있다.
	- 그래서 `useState`와 `useEffect`를 이용해 어떤 조건에서만 호출하게 만들 수 있다.

## 2) 조회 기능 구현하기
- 상품 하나에 대한 상세 조회에 대해서 컴포넌트를 만들고, 해당 컴포넌트를 페이지에 적용해야 한다.

```javascript

```


## 3) 네비게이션 관련 커스텀 훅 만들기
```javascript
import { createSearchParams, useNavigate, useSearchParams } from 'react-router-dom'

const getNum = (param, defaultValue) => {
	if (!param) {
		return defaultValue
	}
	return parseInt(param)
}

const useCustomMove = () => {
	const navigate = useNavigate();
	const [queryParams] = useSearchParams();

	const page = getNum(queryParams.get('page'), 1);
	const size = getNum(queryParams.get('size'), 10);

	const queryDefault = createSearchParams({ page, size }).toString();
	
	const moveToList = (pageParam) => {
		let queryStr = "";

		if (pageParam) {
			const pageNum = getNum(pageParam.get('page'), 1);
			const sizeNum = getNum(pageParam.get('size'), 10);
			
			queryStr = createSearchParams({ page: pageNum, size: sizeNum }).toString();
	
		} else {
			queryStr = queryDefault;
		}

		navigate({ pathname: '../list', search: queryStr });
	}
	return { moveToList }
}

export default useCustomMove
```

## 4) 수정 페이지로 이동하기
- 상세 조회 페이지에서 수정 페이지로 이동할 수 있어야 한다.
- 해당 부분도 `useCustomMove` 에 만들어준다.
```javascript
const moveToModify = (id) => {
	navigate({
		pathname: `../modify/${id}`,
		search: queryDefault
	})
}
...
return { moveToList, moveToModify, page, size }
...
```

## 5) 목록 처리하기

### (1) 
- 리스트 컴포넌트를 만들어줘서 해당 컴포넌트에서 처리해줄 것이다.

### (2) 목록 페이징 처리하기
- 리스트 밑에 페이지 번호 컴포넌트를 추가할 것이다.
- 해당 컴포넌트는 공통 컴포넌트이므로 `common` 이라는 폴더에 새로 만들어주자.
```javascript
import React from 'react'

const PageComponent = ({ serverData, movePage }) => {
	return (
		<div className="m-6 flex justify-center">
			{serverData.prev ? <div className="m-2 p-2 w-16 text-center font-bold text-blue-400" onClick={() => movePage({ page: serverData.prevPage })}>
				Prev
			</div> : <></>}

		{serverData.pageNumberList.map(pageNum =>
			<div key={pageNum} className={`m-2 p-2 w-12 text-center rounded shadow-md text-white ${serverData.current === pageNum ? 'bg-gray-500' : 'bg-blue-400'}`} onClick={() => movePage({ page: pageNum })}>
				{pageNum}
			</div>
		)}

		{serverData.next ? <div className="m-2 p-2 w-16 text-center font-bold text-blue-400" onClick={() => movePage({ page: serverData.nextPage })}>
			Next
		</div> : <></>}
		</div>
	)
}

export default PageComponent
```

```javascript
// ListComponent

		<PageComponent serverData={serverData} movePage={moveToList} />
	</div>
)
}
```
### (3) 동일 페이지 클릭 처리하기
- 동일 페이지를 클릭해도 반응이 없는데, 이 부분은 `useEffect`에서 `page, size`가 동일하기 때문이다.
	- ajax가 똑같은 것인줄 알고 데이터를 안가지고 올 수 있다.
- 그래서 그 조건을 만들어줘서 클릭했을 때, true와 false를 왔다갔다 해주는 조건을 만들어줘서 똑같은 페이지를 클릭해도 그대로 동작하게 해주면 된다.

```javascript
const useCustomMove = () => {
	const navigate = useNavigate();
	const [refresh, setRefresh] = useState(false);
...

	const moveToList = (pageParam) => {
		...
		setRefresh(!refresh);
	}
	...

	return { moveToList, moveToModify, page, size, refresh }
}
```

```javascript
const ListComponent = () => {
	const { page, size, refresh, moveToList } = useCustomMove();
	...

	useEffect(() => {
		...
	}, [page, size, refresh]);
```

## 6) 상세 페이지로 이동하기
- 리스트 페이지에서 상세 페이지로 이동하게 해줘야 한다.
### (1) detail 페이지로 이동하는 기능 구현
- 이동하는 기능은 계속해서 `useCustomMove`에서 만들어준다.
```javascript
	...
	const moveToDetail = (number) => {
		navigate({
		pathname: `../detail/${number}`,
		search: queryDefault
	})
	...
}
```
- number를 받는 이유는 어떤 게시판을 만들던 페이징 기능을 만들 때 똑같이 쓸 수 있기 때문이다.

### (2) 리스트 컴포넌트에 기능 연결하기
```javascript
const ListComponent = () => {
	const { page, size, refresh, moveToList, moveToDetail } = useCustomMove();
	...

	{serverData.dtoList.map(product =>
		<div key={product.id} className="w-full min-w-[400px] p-2 m-2 rounded shadow-md" onClick={() => moveToDetail(product.id)}>
		...
```

## 7) 등록 기능 구현하기
### (1) 등록 API 구현하기
- Ajax를 사용했을 때는 `JSON.stringify(obj) => JSON 문자열` 와 같은 과정이 필요하지만, axios를 사용하면 그냥 사용해도 된다.
```javascript
export const postAdd = async (productObj) => {
	const res = await axios.post(`${prefix}/`, productObj);
	return res.data;
}
```

### (2) AddComponent 구현하기
```javascript
import React, { useState } from 'react'

const initState = {
	name: '',
	writer: '',
	uploadDate: '',
}

const AddComponent = () => {
const [product, setProduct] = useState({ ...initState });

const handleChangeProduct = (e) => {
	console.log(e.target.name, e.target.value);
	product[e.target.name] = e.target.value;
	setProduct({ ...product });
}

const handleClickAdd = () => {
	console.log(product);
}

  

return (
	<div className="border-2 border-sky-200 mt-10 m-2 p-4">
		<div className="flex justify-center">
			<div className="relative mb-4 flex w-full flex-wrap items-stretch">
				<div className="w-1/5 p-6 text-right font-bold">NAME</div>
					<input className="w-4/5 p-6 rounded-r border border-solid border-neutral-500 shadow-md" name="title" type={'text'} value={product.name} onChange={handleChangeProduct}></input>
			</div>
		</div>
	
		<div className="flex justify-center">
			<div className="relative mb-4 flex w-full flex-wrap items-stretch">
				<div className="w-1/5 p-6 text-right font-bold">WRITER</div>
					<input className="w-4/5 p-6 rounded-r border border-solid border-neutral-500 shadow-md" name="writer" type={'text'} value={product.writer} onChange={handleChangeProduct}></input>
			</div>
		</div>
	
		<div className="flex justify-center">
			<div className="relative mb-4 flex w-full flex-wrap items-stretch">
				<div className="w-1/5 p-6 text-right font-bold">UPLOAD DATE</div>
					<input className="w-4/5 p-6 rounded-r border border-solid border-neutral-500 shadow-md" name="dueDate" type={'date'} value={product.uploadDate} onChange={handleChangeProduct}></input>
			</div>
		</div>
			
		<div className="flex justify-end">
			<div className="relative mb-4 flex p-4 flex-wrap items-stretch">
				<button type="button" onClick={handleClickAdd} className="rounded p-4 w-36 bg-blue-500 text-xl text-white" > ADD </button>
			</div>
		</div>
	</div>
	)
}
  
export default AddComponent
```

### (3) AddPage와 AddComponent 연결하기
```javascript
import React from 'react'
import AddComponent from '../../components/product/AddComponent'

const ProductAddPage = () => {
	return (
		<div className="p-4 w-full bg-white">
			<div className="text-3xl font-extrabold">
				Product Add Page
			</div>
			<AddComponent />
		</div>
	)
}

export default ProductAddPage
```

## 8) 모달 컴포넌트 만들기
- 과거에 SSR때는 Post 로 등록 -> Redirect -> Get으로 확인 하는 PRG 패턴을 사용했었다.
	- 클라이언트에서 서버에 Post 를 날린다.
	- 서버에서 처리가 끝난 뒤, 클라이언트에 Http 응답을 보내게 된다. 그 HTTP 헤더에 Location이 있는데, Get 방식으로 Location을 호출하게 되서 다른 페이지로 이동하게 된다.
- SPA에서는 위와 같이는 안된다.
	- 경고창은 사용하지 않는다. 경고창은 JS엔진은 멈추겠다는 의미이므로 되도록 사용하지 않고 모달창을 만들어줘야한다.
	- 모달은 페이지에서 서버 호출 및 결과 데이터는 모달로 보여주게 된다. 그리고 모달은 닫으면 이동과 같은 후처리를 할 수 있다.
- 모달을 등록, 수정, 삭제에 필요한 결과창과 조회할 때 필요한 로딩창으로 구분해서 만들어줄 것이다.
```javascript
// components/common/ResultModal.js

import React from 'react'

const ResultModal = ({ title, content, callbackFn }) => {
	return (
		// 화면 전체
		<div className={`fixed top-0 left-0 z-[1055] flex h-full w-full justify-center bg-black bg-opacity-20`} onClick={() => { if (callbackFn) { callbackFn() } }}>
			<div className="absolute bg-white shadow dark:bg-gray-700 opacity-100 w-1/4 rounded mt10 mb-10 px-6 min-w-[600px]">
				<div className="justify-center bg-warning-400 mt-6 mb-6 text-2xl border-b-4 bordergray-500"> {title} </div>
				<div className="text-4xl border-orange-400 border-b-4 pt-4 pb-4"> {content} </div>
				<div className="justify-end flex ">
					<button className="rounded bg-blue-500 mt-4 mb-4 px-6 pt-4 pb-4 text-lg text-white" onClick={() => { if (callbackFn) { callbackFn() } }}>Close Modal</button>
				</div>
			</div>
		</div>
	)
}

export default ResultModal
```
- 해당 모달이 어떤 모달인지에 대한 이름, 내용 그리고 닫을 때 어떤 행동을 할 지에 대해서는 파라미터에 따라 달라지게 만들어져 있다.
	- 특히 `CallbackFn`은 없을 수도 있으므로 있을 경우에만 실행하게 되있다.

### (2) `AddComponent`와 연결하기
- `ResultModel`을 만들고서 등록을 끝낸 `AddComponent`와 연결시켜주자.
- `ResultModal`을 닫게되면 맨 처음 리스트 페이지로 이동하면서 막 등록한 데이터도 볼 수 있게 해주면 된다.
```javascript
import React, { useState } from 'react'
import ResultModal from '../common/ResultModal';
import { postAdd } from '../../api/productApi';
import useCustomMove from '../../hooks/useCustomMove';

...

const AddComponent = () => {
	const [product, setProduct] = useState({ ...initState });
	const [result, setResult] = useState(null);
	const { moveToList } = useCustomMove();
	...
	
	const handleClickAdd = () => {
		postAdd(product).then(result => {
			// {id: 104}
			setResult(result.id);
			setProduct({ ...initState });
		})
	};

	const closeModal = () => {
		setResult(null);
		moveToList();
	};

  

return (
	...
			<button type="button"
			onClick={handleClickAdd}
			className="rounded p-4 w-36 bg-blue-500 text-xl text-white" > ADD </button>
		</div>
	</div>
	
	{result ?
		<ResultModal
			title={'Add Result'}
			content={`New ${result} Added`}
			callbackFn={closeModal}
		/> : <></>}
	</div>
)
}

export default AddComponent
```

## 9) 수정, 삭제 기능 구현하기
### (1) 수정, 삭제 API 만들기
```javascript
// src/api/productApi.js

export const deleteOne = async (id) => {
	const result = await axios.delete(`${prefix}/${id}`);
	return result.data;
}

export const putOne = async (product) => {
	const result = await axios.put(`${prefix}/${product.id}`, product);
	return result.data;
}
```

### (2) `ModifyComponent` 구현하기
- 수정 컴포넌트는 입력 값에 따라 바뀌기도 하고 조회도 해야한다.

```javascript
import React, { useEffect, useState } from 'react'
import { getOne } from '../../api/productApi';

const initState = {
	id: 0,
	name: '',
	writer: '',
	uploadDate: '',
};

  

const ModifyComponent = ({ id }) => {
	const [product, setProduct] = useState(initState);
	
	useEffect(() => {
		getOne(id).then(data => {
			console.log(data);
			setProduct(data);
		});
	}, [id]);

	return (
		<div className="border-2 border-sky-200 mt-10 m-2 p-4">
			<div className="flex justify-end p-4">
				<button type="button" className="inline-block rounded p-4 m-2 text-xl w-32 text-white bg-red-500" > Delete </button>
				<button type="button" className="rounded p-4 m-2 text-xl w-32 text-white bg-blue-500" > Modify </button>
			</div>
		</div>
	)
}

export default ModifyComponent
```

### (3) `ModifyPage`와 연결하기
```javascript
const ProductModifyPage = () => {

	const { id } = useParams();

	return (
		<div className="p-4 w-full bg-white">
			<div className="text-3xl font-extrabold">
				Todo Modify Page
			</div>
			<ModifyComponent id={id} />
		</div>
	)
}
```

### (4) 
```javascript
import React, { useEffect, useState } from 'react'

import { deleteOne, getOne, putOne } from '../../api/productApi';

import useCustomMove from '../../hooks/useCustomMove';

import ResultModal from '../common/ResultModal';

  

const initState = {

id: 0,

name: '',

writer: '',

uploadDate: '',

};

  

const ModifyComponent = ({ id }) => {

const [product, setProduct] = useState(initState);

  

const [result, setResult] = useState(null);

  

// 수정 -> 조회

// 삭제 -> 목록 이동

const { moveToList, moveToDetail } = useCustomMove();

  
  

useEffect(() => {

getOne(id).then(data => {

console.log(data);

setProduct(data);

});

}, [id]);

  

const handleChangeProduct = (e) => {

console.log(e.target.name, e.target.value);

product[e.target.name] = e.target.value;

  

setProduct({ ...product });

};

  

const handleClickDelete = () => {

deleteOne(id).then(data => {

console.log(data);

setResult('Deleted');

})

};

  

const handleClickModify = () => {

putOne(product).then(data => {

console.log(data);

setResult('Modified');

})

};

  

const closeModal = () => {

if (result === 'Deleted') {

moveToList();

} else {

moveToDetail(id);

}

};

  

return (

<div className="border-2 border-sky-200 mt-10 m-2 p-4">

<div className="flex justify-center mt-10">

<div className="relative mb-4 flex w-full flex-wrap items-stretch">

<div className="w-1/5 p-6 text-right font-bold">ID</div>

<div className="w-4/5 p-6 rounded-r border border-solid shadow-md bg-gray-100"> {product.id} </div>

</div>

</div>

<div className="flex justify-center">

<div className="relative mb-4 flex w-full flex-wrap items-stretch">

<div className="w-1/5 p-6 text-right font-bold">WRITER</div>

<div className="w-4/5 p-6 rounded-r border border-solid shadow-md bg-gray-100"> {product.writer} </div>

</div>

</div>

<div className="flex justify-center">

<div className="relative mb-4 flex w-full flex-wrap items-stretch">

<div className="w-1/5 p-6 text-right font-bold">TITLE</div>

<input className="w-4/5 p-6 rounded-r border border-solid border-neutral-300 shadow-md"

name="title" type={'text'} value={product.title} onChange={handleChangeProduct} ></input>

</div>

</div>

  

<div className="flex justify-center">

<div className="relative mb-4 flex w-full flex-wrap items-stretch">

<div className="w-1/5 p-6 text-right font-bold">DUEDATE</div>

<input className="w-4/5 p-6 rounded-r border border-solid border-neutral-300 shadow-md"

name="dueDate" type={'date'} value={product.uploadDate} onChange={handleChangeProduct} ></input>

</div>

</div>

<div className="flex justify-end p-4">

<button type="button" className="inline-block rounded p-4 m-2 text-xl w-32 text-white bg-red-500"

onClick={handleClickDelete}>

Delete </button>

<button type="button" className="rounded p-4 m-2 text-xl w-32 text-white bg-blue-500"

onClick={handleClickModify}> Modify </button>

</div>

{result ? <ResultModal title={'처리 결과'} content={result} callbackFn={closeModal} /> : <></>}

</div>

)

}

  

export default ModifyComponent
```