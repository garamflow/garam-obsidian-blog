# 2. 스프링 배치 프로젝트 및 DB 스키마

## 2.1 프로젝트 구성 및 의존성 설정
- gradle
- java 21
- spring boot 3.3.4
- mysql:latest
- 의존성
```groovy
dependencies {  
    implementation 'org.springframework.boot:spring-boot-starter-batch'  
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'  
    implementation 'org.springframework.boot:spring-boot-starter-thymeleaf'  
    implementation 'org.springframework.boot:spring-boot-starter-web'  
    developmentOnly 'org.springframework.boot:spring-boot-devtools'  
    runtimeOnly 'com.mysql:mysql-connector-j'  
    testImplementation 'org.springframework.boot:spring-boot-starter-test'  
    testImplementation 'org.springframework.batch:spring-batch-test'  
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'  
}
```

### 2.1.1 스프링 배치 활성화 - `@EnableBatchProcessing`
스프링 배치가 작동하기 위해 선언해야 하는 어노테이션이었지만 5버전부터는 더이상 필수가 아니게 되었습니다. 이제는 사용하지 않아도 빈 등록을 자동으로 해줍니다.

> @EnableBatchProcessing 와 DefaultBatchConfiguration을 동시에 사용하면 안 됩니다.

```java
// 이전 버전 예시
@SpringBootApplication
@EnableBatchProcessing
public class SpringBatchApplication {

    public static void main(String[] args) {
        SpringApplication.run(SpringBatchApplication.class, args);
    }
}
```

### 2.1.2 자동 설정
5 버전 이후부터는 아래 클래스들이 자동으로 실행되어 필요한 빈들이 등록됩니다.

- **`BatchAutoConfiguration`**:
    - Spring Boot에서 제공하는 배치 관련 자동 설정 클래스
    - 배치 애플리케이션에서 필수적인 구성 요소들(`JobRepository`, `JobLauncher` 등)을 자동으로 설정하고 빈으로 등록함
    - `@EnableBatchProcessing`을 사용하지 않아도 Spring Boot 애플리케이션에서 이 클래스가 자동으로 빈을 등록해 줌
- **`SimpleBatchConfiguration`**:
    - 기본적인 배치 구성 클래스
    - 스프링 배치에서 필요한 기본 설정을 제공하며, Spring Boot 환경에서는 자동으로 적용됨
    - 이 클래스는 자동으로 **BatchConfigurer**를 생성하고 빈으로 등록함
- **`BatchConfigurerConfiguration`**:
    - 배치 구성을 정의하는 설정 클래스
    - `BatchConfigurer` 인터페이스를 구현한 **BasicBatchConfigurer**나 **JpaBatchConfigurer**와 같은 클래스를 빈으로 등록하는 역할을 함
- **`BasicBatchConfigurer`**:
    - 기본적인 배치 설정을 제공하는 구성 클래스
    - 데이터베이스 설정과 관련된 기본적인 배치 구성 요소를 자동으로 설정함
    - `BatchConfigurer` 인터페이스를 구현하여 **JobRepository**, **JobLauncher** 등을 설정하고 빈으로 등록함
- **`JpaBatchConfigurer`**:
    - **JPA 기반 배치 설정**을 위한 구성 클래스
    - JPA를 사용하는 경우, `BasicBatchConfigurer` 대신 사용되며, JPA 기반으로 배치 인프라 설정을 자동화함

이제는 Spring Boot 애플리케이션이 Spring Batch를 감지하면, 자동으로 `BatchAutoConfiguration`이 로드되며, 이 클래스가 내부적으로 위에 언급된 클래스들(**SimpleBatchConfiguration**, **BatchConfigurerConfiguration**, **BasicBatchConfigurer**, **JpaBatchConfigurer**)을 필요에 따라 빈으로 등록해 줍니다.

## 2.2 스프링 배치 기본 설정 및 실행
스프링 배치가 최신 버전이 되면서 Factory 기반 설정이 더 이상 권장되지 않습니다. 이제는 직접 **빌더 패턴**을 사용하여 Job과 Step을 정의해야 합니다. 이런 변화는 자동 설정을 강화하고, **명시적인 빈 주입**을 통해 더 유연한 설정을 가능하게 하며, **병렬 처리나 가상 스레드와 같은 최신 기능 지원**을 위함입니다. 또한, 설정 간소화와 명시적 의존성 주입을 통해 가독성과 유지 보수성을 높이기 위해서 입니다.

### 2.2.1 Config 설정 시 이전 버전에서 주요 변경 사항
- **JobBuilderFactory, StepBuilderFactory Deprecated**
	- 이전 버전에서 사용된 `JobBuilderFactory`, `StepBuilderFactory`는 더 이상 사용되지 않으며, 대신 **`JobBuilder`**, **`StepBuilder`** 를 직접 생성하여 사용합니다.
- **`JobRepository` 직접 사용**
	- Job과 Step을 생성할 때, 이제는 `JobRepository`를 직접 전달하여 관리합니다.
	- 이로 인해 Spring Batch의 Job 및 Step 구성이 더욱 명시적이 되고, Job 관리가 향상되었습니다.
- **`PlatformTransactionManager` 사용**
	- Step에서 `tasklet`이나 Chunk 기반 작업을 실행할 때 **`PlatformTransactionManager`** 를 명시적으로 전달해야 합니다.
	- 이를 통해 트랜잭션 관리가 더 유연해집니다.

### 2.2.2 최신 버전 JobBuilder와 StepBuilder 직접 사용 예시 및 코드 설명
```java
@Configuration
public class BatchConfig { // @Configuration ~ class : 하나의 배치 Job 을 정의하고 빈 설정 

	/*
	* - 배치 작업(Job)을 정의하는 빈 생성
	* - JobBuilder를 사용해 "helloJob"이라는 Job을 생성하고, Job 실행 단위인 Step 연결
	* - JobRepository는 배치 실행 메타데이터를 저장하고 관리하는 역할. 해당 객체는 Job의 상태와 진행 상황을 관리하는 데 사용
	* - helloStep: 배치 작업에서 수행할 실제 단위를 의미하는 
	*/
    @Bean
    public Job helloJob(JobRepository jobRepository, Step helloStep) {
        return new JobBuilder("helloJob", jobRepository)
                .start(helloStep)
                .build();
    }

    @Bean
    public Step helloStep(JobRepository jobRepository, PlatformTransactionManager transactionManager) {
        return new StepBuilder("helloStep", jobRepository)
                .tasklet(helloTasklet(), transactionManager)
                .build();
    }

    @Bean
    public Tasklet helloTasklet() {
        return (contribution, chunkContext) -> {
            System.out.println("Hello, Spring Batch!");
            return RepeatStatus.FINISHED;
        };
    }
}
```


## 2.3 DB 스키마 생성 및 이해 (1)


## 2.4 DB 스키마 생성 및 이해 (2)

