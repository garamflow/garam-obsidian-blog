# 4. 스프링 배치 실행 - Job
## 4.1 배치 초기화 설정
### 4.1.1 JobLauncherApplicationRunner
- **JobLauncherApplicationRunner**는 **Spring Batch** 작업을 시작하는 **ApplicationRunner**의 구현체로, 애플리케이션이 구동된 후 **Spring Batch**의 모든 **Job**을 실행하는 역할을 합니다.
- **BatchAutoConfiguration**에서 생성되며, **Spring Boot** 애플리케이션이 정상적으로 시작되면 **JobLauncherApplicationRunner**가 자동으로 등록된 **Job**을 실행합니다.
- 기본적으로 **모든 Job**이 실행되지만, 특정 **Job**을 지정하여 실행할 수도 있습니다.

### 4.1.2 BatchProperties
- **BatchProperties**는 **Spring Batch**의 환경 설정을 관리하는 구성 클래스입니다. 이를 통해 **Job**의 이름, 스키마 초기화, 테이블 접두사 등 배치 관련 설정을 할 수 있습니다.
- **application.properties** 또는 **application.yml** 파일에서 설정합니다.

- **설정 가능한 항목**:
	- **job.names**: 실행할 **Job**의 이름을 지정합니다. 여러 **Job**을 실행할 경우 쉼표로 구분합니다.
	- **initialize-schema**: 배치 테이블 스키마를 초기화할지 여부를 설정합니다. 기본값은 `NEVER`이며, 필요 시 `ALWAYS`, `EMBEDDED` 등으로 설정할 수 있습니다.
	- **tablePrefix**: 배치 메타데이터 테이블의 접두사를 설정합니다. 기본값은 `BATCH_`입니다.

- **application.yml** 예시:
```yaml
batch:
	job:
	  names: ${job.name:NONE}
	initialize-schema: NEVER
	tablePrefix: SYSTEM
```

### 4.1.3 Job 실행 옵션
- 기본적으로 **JobLauncherApplicationRunner**는 모든 등록된 **Job**을 실행하지만, 특정 **Job**만 실행하도록 설정할 수 있습니다.
- **Program arguments**로 실행할 **Job**의 이름을 지정합니다.
- 여러 **Job**을 실행하려면 쉼표로 구분합니다.
- **명령어 예시**:
```bash
--job.name=helloJob
--job.name=helloJob,simpleJob
```

**application.yml**에서 설정된 값이 없으면 **Job**은 실행되지 않습니다:
```yaml
batch:
	job:
	  names: NONE
```

### 4.1.4 동기 및 비동기 실행
- **JobLauncher**의 실행 방식은 동기 및 비동기로 설정할 수 있습니다:
	- **동기적 실행**: 기본적으로 **SyncTaskExecutor**를 사용하며, 배치 작업이 완료된 후 **JobExecution**을 반환합니다.
	- **비동기적 실행**: **SimpleAsyncTaskExecutor**를 사용해 작업을 백그라운드에서 처리하고, 즉시 **JobExecution**을 반환합니다. 이는 HTTP 요청 기반의 배치 처리에 적합합니다.

### 4.1.5 최신 버전 기준으로 **Job Name** 설정과 **YAML** 연동을 설명하는 예시입니다.
#### 1. YAML 설정 파일 (application.yml)
```yaml
batch:
  job:
    names: ${job.name:NONE}  # 실행할 Job 이름을 환경변수나 CLI 인자로 받아옴
```
- **`${job.name:NONE}`**: 환경변수나 **CLI 인자**로 전달된 **job.name** 값이 있으면 그 값을 사용하고, 없으면 기본값으로 `NONE`을 사용한다는 의미입니다.

#### 2. 실제 코드 (최신 버전 기준)
```java
import org.springframework.batch.core.Job;
import org.springframework.batch.core.JobExecution;
import org.springframework.batch.core.JobParameters;
import org.springframework.batch.core.Step;
import org.springframework.batch.core.configuration.annotation.EnableBatchProcessing;
import org.springframework.batch.core.repository.JobRepository;
import org.springframework.batch.core.step.tasklet.Tasklet;
import org.springframework.batch.core.step.builder.StepBuilder;
import org.springframework.batch.core.job.builder.JobBuilder;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.transaction.PlatformTransactionManager;

@Configuration
@EnableBatchProcessing
public class BatchJobConfig {

    private final JobRepository jobRepository;
    private final PlatformTransactionManager transactionManager;

    public BatchJobConfig(JobRepository jobRepository, PlatformTransactionManager transactionManager) {
        this.jobRepository = jobRepository;
        this.transactionManager = transactionManager;
    }

    @Bean
    public Job myJob() {
        return new JobBuilder("myJob", jobRepository)
            .start(step1())
            .build();
    }

    @Bean
    public Job simpleJob() {
        return new JobBuilder("simpleJob", jobRepository)
            .start(step2())
            .build();
    }

    @Bean
    public Step step1() {
        return new StepBuilder("step1", jobRepository)
            .tasklet(myTasklet(), transactionManager)
            .build();
    }

    @Bean
    public Step step2() {
        return new StepBuilder("step2", jobRepository)
            .tasklet(myTasklet(), transactionManager)
            .build();
    }

    @Bean
    public Tasklet myTasklet() {
        return (contribution, chunkContext) -> {
            System.out.println("Tasklet executed");
            return RepeatStatus.FINISHED;
        };
    }
}
```

#### 3. 코드 설명
- **JobBuilder**와 **StepBuilder**는 **JobRepository**와 함께 사용하여 배치 작업을 설정합니다. 이는 5.x 버전에서 권장되는 방식입니다.
- **JobRepository**는 배치 실행 중 메타데이터를 저장하고, **PlatformTransactionManager**를 사용하여 트랜잭션을 관리합니다.
- 각 **Step**은 **Tasklet**을 사용하여 작업을 정의하고 실행합니다.

#### 4. CLI 명령어로 Job Name 설정 및 실행
```bash
java -jar your-spring-batch-app.jar --job.name=myJob
```
- 위 명령어로 **YAML 파일**의 `${job.name}`에 `myJob` 값을 전달하여 **myJob**이 실행됩니다.

## 4.2 JobBuilderFactory / JobBuilder

1. 스프링 배치는 Job 과 Step 을 쉽게 생성 및 설정할 수 있도록 util 성격의 빌더 클래스들을 제공함 2. JobBuilderFactory • JobBuilder 를 생성하는 팩토리 클래스로서 get(String name) 메서드 제공 • jobBuilderFactory.get(“jobName") • “jobName” 은 스프링 배치가 Job 을 실행시킬 때 참조하는 Job 의 이름 3. JobBuilder • Job 을 구성하는 설정 조건에 따라 두 개의 하위 빌더 클래스를 생성하고 실제 Job 생성을 위임한다 • SimpleJobBuilder • SimpleJob 을 생성하는 Builder 클래스 • Job 실행과 관련된 여러 설정 API 를 제공한다 • FlowJobBuilder • FlowJob 을 생성하는 Builder 클래스 • 내부적으로 FlowBuilder 를 반환함으로써 Flow 실행과 관련된 여러 설정 API 를 제공한다

