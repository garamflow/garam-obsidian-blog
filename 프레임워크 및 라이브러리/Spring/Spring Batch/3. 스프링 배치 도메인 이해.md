# 3. 스프링 배치 도메인 이해 - 
## 3.1 Job
### 3.1.1 기본 개념
- **Job**
	- 스프링 배치에서 가장 상위 개념으로, 하나의 배치 작업을 의미
	- 예를 들어, "API 서버의 접속 로그 데이터를 통계 서버로 옮기는 배치" 같은 작업 자체를 지칭
- **Job Configuration**
	- 배치 작업의 실행 방식과 구성을 정의하는 객체
	- 배치 작업을 어떻게 구성하고 실행할 것인지에 대한 명세를 포함
- **최상위 인터페이스**
	- Job은 스프링 배치의 최상위 인터페이스로, 스프링 배치는 이 인터페이스의 기본 구현체들을 제공
- **컨테이너 역할**
	- 여러 개의 Step을 포함하는 컨테이너로서 반드시 하나 이상의 Step으로 구성
	- Job은 실행될 각 Step을 정의하고 관리하는 구조

### 3.1.2 기본 구현체
- **SimpleJob**
	- 가장 일반적인 Job 구현체로, 순차적으로 Step을 실행
	- 모든 Job에서 유용하게 사용할 수 있는 표준 기능 제공
- **FlowJob**
	- 특정 조건이나 흐름에 따라 Step을 실행하는 Job
	- Flow 객체를 기반으로 작업의 흐름을 제어하며, 복잡한 조건에 따른 실행을 지원

### 3.1.3 Job 실행 과정의 순서
#### 1. JobLauncher 실행
   - **JobLauncher**가 배치 작업을 시작하는 역할을 합니다. `Job`과 `JobParameters`를 받아 배치 작업을 실행합니다.
   - **JobParameters**는 외부에서 전달된 파라미터로, 배치 작업의 유일성을 보장하거나 실행 시 특정 조건을 전달하는 데 사용됩니다.
   
   ```java
   jobLauncher.run(job, jobParameters);
   ```

#### 2. JobRepository에서 JobExecution 생성 및 저장
   - **JobRepository**는 Job의 실행 상태 및 메타데이터를 저장하는 역할을 합니다. 
   - Job이 시작되면 **JobExecution** 객체가 생성되어 **JobRepository**에 저장됩니다. 이 객체는 Job의 실행 상태, 시작 시간, 종료 시간 등의 정보를 기록합니다.

#### 3. JobExecutionListener의 pre-processing 수행
   - 만약 **JobExecutionListener**가 설정되어 있다면, Job이 실행되기 전에 **beforeJob(JobExecution)** 메서드가 호출됩니다.
   - 이 과정에서 로그 기록, 리소스 초기화 등의 선처리 작업이 이루어집니다.

#### 4. Job의 실행
   - **Job**의 `execute(JobExecution jobExecution)` 메서드가 호출되어 Job이 실행됩니다.
   - **SimpleJob**은 순차적으로 각 **Step**을 실행하며, **FlowJob**은 조건에 따라 **Step**을 선택적으로 실행합니다.
   - **Job** 내부에는 여러 **Step**이 포함되어 있으며, 이 Step들은 `steps` 리스트에 관리됩니다.

#### 5. Step 실행
   - Job은 내부의 **Step**들을 차례대로 실행하거나 조건에 따라 실행합니다.
   - 각 **Step**은 `StepExecution` 객체를 생성하여 해당 Step의 실행 상태를 추적합니다.
   - **Step** 실행 시, 다음과 같은 과정이 이루어집니다:
     - **Reader**: 데이터를 외부 소스(DB, 파일 등)에서 읽어옵니다.
     - **Processor**: 읽어온 데이터를 가공합니다.
     - **Writer**: 가공된 데이터를 저장하거나 출력합니다.

#### 6. Step의 성공 여부 확인
   - 각 **Step**이 성공적으로 완료되면, **StepExecution** 상태가 업데이트되며, 다음 **Step**이 실행됩니다.
   - 만약 **Step**이 실패하면, Job의 재시작 여부에 따라 중단되거나 재시작 가능한 상태로 남겨집니다.

#### 7. Job 종료
   - 모든 Step이 정상적으로 완료되면 **JobExecution** 상태가 성공으로 업데이트됩니다.
   - **JobRepository**에 최종 상태가 저장되고, Job의 종료 시간이 기록됩니다.

#### 8. JobExecutionListener의 post-processing 수행
   - Job이 완료된 후, **JobExecutionListener**의 **afterJob(JobExecution)** 메서드가 호출되어 후처리 작업이 진행됩니다.
   - Job 성공 또는 실패에 따라 로그 기록, 알림 전송 등 후속 작업이 이루어집니다.

#### 9. 최종 Job 상태 반환
   - Job 실행이 완료되면 **JobExecution** 객체가 최종 실행 상태(성공, 실패, 중단 등)를 반환합니다.
   - 이를 통해 후속 처리가 가능합니다.

#### 10. **요약**
1. **JobLauncher**가 `Job`과 `JobParameters`로 배치 실행 시작.
2. **JobRepository**에 **JobExecution** 객체 생성 및 저장.
3. **JobExecutionListener**의 `beforeJob()`으로 선처리 작업 수행.
4. **Job**이 `execute()` 메서드로 **Step** 실행 시작.
5. 각 **Step**은 Reader, Processor, Writer 단계를 거쳐 실행.
6. **Step** 성공 여부에 따라 다음 **Step** 실행 또는 Job 중단.
7. 모든 **Step** 완료 후 **JobExecution** 상태 업데이트.
8. **JobExecutionListener**의 `afterJob()`으로 후처리 작업 수행.
9. **JobExecution** 객체로 최종 Job 실행 상태 반환.

### 3.1.4 관련 구성 요소
- **name**: Job의 이름을 설정. 이는 Job의 고유한 식별자로 사용됨.
- **restartable**: Job의 재시작 가능 여부. 기본값은 `true`로 설정되어 있으며, 재시작 가능한 배치 작업을 지원.
- **JobRepository**: Job의 실행 이력과 메타데이터를 저장하는 저장소.
- **JobExecutionListener**: Job의 실행 전후에 실행되는 이벤트 리스너로, 배치 작업의 전반적인 상태를 관리하고 모니터링.
- **JobParametersIncrementer**: 배치 실행 시 매번 다른 JobParameter를 생성해주는 인터페이스.
- **JobParametersValidator**: JobParameter의 유효성을 검증하는 컴포넌트.
- **SimpleStepHandler**: Step을 처리하는 기본 핸들러로서, 각 Step을 순차적으로 실행하는 역할.

# 3.2 JobInstance
기본 개념 • Job 이 실행될 때 생성되는 Job 의 논리적 실행 단위 객체로서 고유하게 식별 가능한 작업 실행을 나타냄 • Job 의 설정과 구성은 동일하지만 Job 이 실행되는 시점에 처리하는 내용은 다르기 때문에 Job 의 실행을 구분해야 함 • 예를 들어 하루에 한 번 씩 배치 Job이 실행된다면 매일 실행되는 각각의 Job 을 JobInstance 로 표현합니다. • JobInstance 생성 및 실행 • 처음 시작하는 Job + JobParameter 일 경우 새로운 JobInstance 생성 • 이전과 동일한 Job + JobParameter 으로 실행 할 경우 이미 존재하는 JobInstance 리턴 • 내부적으로 JobName + jobKey (jobParametes 의 해시값) 를 가지고 JobInstance 객체를 얻음 • Job 과는 1:M 관계 2. BATCH_JOB_INSTANCE 테이블과 매핑 • JOB_NAME (Job) 과 JOB_KEY (JobParameter 해시값) 가 동일한 데이터는 중복해서 저장할 수 없음

joblauncher
job jobparameters
run(job, parameters)
jobrepository
job & jobparameters -> db
exist? 
yes jobinstance(jobname, jobkey) 기존 jobinstance 리턴
no 새로운 jobinstance